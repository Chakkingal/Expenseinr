<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personal Expense Dashboard</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body {
            background: #f4f6f9;
            font-family: "Segoe UI", sans-serif;
        }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.08);
        }

        .summary-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #111;
            margin-top: 4px;
        }

        .small-muted {
            font-size: 0.85rem;
            color: #666;
        }

        .table thead th {
            background: #222;
            color: white;
            font-size: 0.85rem;
        }

        .table tbody td {
            font-size: 0.85rem;
            vertical-align: middle;
        }

        .badge-mode {
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: 18px;
            background: #0d6efd;
            color: white;
            display: inline-block;
            white-space: nowrap;
        }

        .page-title {
            font-weight: 800;
            font-size: 1.4rem;
        }

        .loading {
            font-weight: 600;
            color: #666;
        }

        canvas {
            max-height: 280px;
        }

        @media(max-width: 768px) {
            .summary-value {
                font-size: 1.3rem;
            }

            canvas {
                max-height: 220px;
            }
        }
    </style>
</head>

<body>

    <div class="container py-4">

        <!-- Header -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
            <div>
                <div class="page-title">üí∞ Personal Finance Dashboard</div>
                <div class="small-muted">Live dashboard from Google Sheets CSV</div>
            </div>

            <div class="d-flex gap-2 flex-wrap">
                <select id="monthFilter" class="form-select" style="min-width:180px;">
                    <option value="ALL">All Months</option>
                </select>

                <input id="searchBox" type="text" class="form-control" placeholder="Search..."
                    style="min-width:180px;" />

                <button class="btn btn-dark" onclick="loadAllData()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card p-3">
                    <div class="summary-title">Total Expense</div>
                    <div class="summary-value" id="totalExpense">--</div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card p-3">
                    <div class="summary-title">Total Receipts</div>
                    <div class="summary-value" id="totalReceipts">--</div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card p-3">
                    <div class="summary-title">Net Cash Flow</div>
                    <div class="summary-value" id="netCashflow">--</div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card p-3">
                    <div class="summary-title">Transactions</div>
                    <div class="summary-value" id="totalTransactions">--</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6">
                <div class="card p-3">
                    <h6 class="fw-bold">üìà Expense Trend (All Months)</h6>
                    <canvas id="expenseTrendChart"></canvas>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card p-3">
                    <h6 class="fw-bold">üè¶ Expense by Mode</h6>
                    <canvas id="expenseModeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6">
                <div class="card p-3">
                    <h6 class="fw-bold">üßæ Expense by Group</h6>
                    <canvas id="expenseGroupChart"></canvas>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card p-3">
                    <h6 class="fw-bold">üìä Receipts vs Expense</h6>
                    <canvas id="receiptVsExpenseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tables -->
        <div class="row g-3">
            <div class="col-12">
                <div class="card p-3">
                    <h6 class="fw-bold">üìù Latest Expense Entries</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mt-2">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Month</th>
                                    <th>Item</th>
                                    <th>SubGroup</th>
                                    <th>Group</th>
                                    <th>Mode</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTable">
                                <tr>
                                    <td colspan="7" class="loading">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card p-3">
                    <h6 class="fw-bold">üíµ Latest Receipts</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mt-2">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Month</th>
                                    <th>From</th>
                                    <th>Mode</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="receiptTable">
                                <tr>
                                    <td colspan="5" class="loading">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card p-3">
                    <h6 class="fw-bold">üîÅ Contra Transfers</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mt-2">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Month</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="contraTable">
                                <tr>
                                    <td colspan="5" class="loading">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // ==========================
        // YOUR CSV LINKS
        // ==========================
        const expenseCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGMtUiblqToKMbbbHYVcfw2g_cloxoXkvtmo7jF7HL6DZcqINtKwR8taPX9l269GFBRHsZ2oPXZ9GC/pub?gid=0&single=true&output=csv";
        const receiptsCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGMtUiblqToKMbbbHYVcfw2g_cloxoXkvtmo7jF7HL6DZcqINtKwR8taPX9l269GFBRHsZ2oPXZ9GC/pub?gid=1584371430&single=true&output=csv";
        const contraCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGMtUiblqToKMbbbHYVcfw2g_cloxoXkvtmo7jF7HL6DZcqINtKwR8taPX9l269GFBRHsZ2oPXZ9GC/pub?gid=1766372454&single=true&output=csv";

        let expenseData = [];
        let receiptData = [];
        let contraData = [];

        let expenseTrendChart, expenseModeChart, expenseGroupChart, receiptVsExpenseChart;

        // ==========================
        // HELPERS
        // ==========================
        function parseCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (err) => reject(err)
                });
            });
        }

        function formatMoney(num) {
            if (!num || isNaN(num)) return "0.00";
            return Number(num).toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function toNumber(value) {
            if (!value) return 0;
            return parseFloat(String(value).replace(/,/g, "")) || 0;
        }

        function cleanRow(row) {
            const cleaned = {};
            for (let key in row) {
                cleaned[key.trim()] = (row[key] || "").toString().trim();
            }
            return cleaned;
        }

        function removeEmptyRows(data) {
            return data
                .map(cleanRow)
                .filter(r => Object.values(r).some(v => v !== ""));
        }

        function getFilteredData(data) {
            const selectedMonth = document.getElementById("monthFilter").value;

            if (selectedMonth === "ALL") {
                return data.filter(r => r.Date);
            }

            return data.filter(r => (r.Month || "").trim() === selectedMonth && r.Date);
        }

        function getSearchFilteredData(data) {
            const q = document.getElementById("searchBox").value.trim().toLowerCase();
            if (!q) return data;

            return data.filter(row => {
                return Object.values(row).join(" ").toLowerCase().includes(q);
            });
        }

        // ==========================
        // MONTH DROPDOWN
        // ==========================
        function fillMonthDropdown() {
            const monthSet = new Set();

            expenseData.forEach(r => monthSet.add((r.Month || "").trim()));
            receiptData.forEach(r => monthSet.add((r.Month || "").trim()));
            contraData.forEach(r => monthSet.add((r.Month || "").trim()));

            const monthList = Array.from(monthSet).filter(m => m);

            // Sort by year if possible (like Jan-2026)
            monthList.sort((a, b) => a.localeCompare(b));

            const dropdown = document.getElementById("monthFilter");
            dropdown.innerHTML = `<option value="ALL">All Months</option>`;

            monthList.forEach(m => {
                dropdown.innerHTML += `<option value="${m}">${m}</option>`;
            });

            dropdown.onchange = updateDashboard;
        }

        // ==========================
        // SUMMARY
        // ==========================
        function updateSummary() {
            const exp = getSearchFilteredData(getFilteredData(expenseData));
            const rec = getSearchFilteredData(getFilteredData(receiptData));

            const totalExp = exp.reduce((sum, r) => sum + toNumber(r.Amount), 0);
            const totalRec = rec.reduce((sum, r) => sum + toNumber(r.Amount), 0);
            const net = totalRec - totalExp;

            document.getElementById("totalExpense").innerText = "‚Çπ " + formatMoney(totalExp);
            document.getElementById("totalReceipts").innerText = "‚Çπ " + formatMoney(totalRec);
            document.getElementById("netCashflow").innerText = "‚Çπ " + formatMoney(net);
            document.getElementById("totalTransactions").innerText = exp.length + rec.length;
        }

        // ==========================
        // TABLES
        // ==========================
        function updateExpenseTable() {
            let exp = getSearchFilteredData(getFilteredData(expenseData))
                .filter(r => r.Date && r.Amount);

            exp = exp.slice(Math.max(exp.length - 20, 0)).reverse();

            const tbody = document.getElementById("expenseTable");
            tbody.innerHTML = "";

            exp.forEach(r => {
                tbody.innerHTML += `
        <tr>
          <td>${r.Date || ""}</td>
          <td>${r.Month || ""}</td>
          <td>${r.Item || ""}</td>
          <td>${r.SubGroup || ""}</td>
          <td>${r.Group || ""}</td>
          <td><span class="badge-mode">${r.Mode || ""}</span></td>
          <td class="text-end">‚Çπ ${formatMoney(toNumber(r.Amount))}</td>
        </tr>
      `;
            });

            if (exp.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center">No expense data</td></tr>`;
            }
        }

        function updateReceiptTable() {
            let rec = getSearchFilteredData(getFilteredData(receiptData))
                .filter(r => r.Date && r.Amount);

            rec = rec.slice(Math.max(rec.length - 15, 0)).reverse();

            const tbody = document.getElementById("receiptTable");
            tbody.innerHTML = "";

            rec.forEach(r => {
                tbody.innerHTML += `
        <tr>
          <td>${r.Date || ""}</td>
          <td>${r.Month || ""}</td>
          <td>${r.From || ""}</td>
          <td><span class="badge-mode">${r.Mode || ""}</span></td>
          <td class="text-end">‚Çπ ${formatMoney(toNumber(r.Amount))}</td>
        </tr>
      `;
            });

            if (rec.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center">No receipts data</td></tr>`;
            }
        }

        function updateContraTable() {
            let con = getSearchFilteredData(getFilteredData(contraData))
                .filter(r => r.Date && r.Amount);

            con = con.slice(Math.max(con.length - 15, 0)).reverse();

            const tbody = document.getElementById("contraTable");
            tbody.innerHTML = "";

            con.forEach(r => {
                tbody.innerHTML += `
        <tr>
          <td>${r.Date || ""}</td>
          <td>${r.Month || ""}</td>
          <td>${r.From || ""}</td>
          <td>${r.To || ""}</td>
          <td class="text-end">‚Çπ ${formatMoney(toNumber(r.Amount))}</td>
        </tr>
      `;
            });

            if (con.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center">No contra data</td></tr>`;
            }
        }

        // ==========================
        // CHARTS
        // ==========================
        function updateCharts() {
            const exp = getSearchFilteredData(getFilteredData(expenseData));
            const rec = getSearchFilteredData(getFilteredData(receiptData));

            // Expense Trend (All months always)
            const monthTotals = {};
            expenseData.forEach(r => {
                const m = (r.Month || "").trim();
                if (!m) return;
                monthTotals[m] = (monthTotals[m] || 0) + toNumber(r.Amount);
            });

            const months = Object.keys(monthTotals);
            const totals = Object.values(monthTotals);

            if (expenseTrendChart) expenseTrendChart.destroy();
            expenseTrendChart = new Chart(document.getElementById("expenseTrendChart"), {
                type: "line",
                data: {
                    labels: months,
                    datasets: [{
                        label: "Expense",
                        data: totals,
                        tension: 0.3
                    }]
                }
            });

            // Expense by Mode
            const modeTotals = {};
            exp.forEach(r => {
                const mode = (r.Mode || "").trim();
                if (!mode) return;
                modeTotals[mode] = (modeTotals[mode] || 0) + toNumber(r.Amount);
            });

            if (expenseModeChart) expenseModeChart.destroy();
            expenseModeChart = new Chart(document.getElementById("expenseModeChart"), {
                type: "bar",
                data: {
                    labels: Object.keys(modeTotals),
                    datasets: [{
                        label: "Expense",
                        data: Object.values(modeTotals)
                    }]
                }
            });

            // Expense by Group
            const groupTotals = {};
            exp.forEach(r => {
                const g = (r.Group || "").trim();
                if (!g) return;
                groupTotals[g] = (groupTotals[g] || 0) + toNumber(r.Amount);
            });

            if (expenseGroupChart) expenseGroupChart.destroy();
            expenseGroupChart = new Chart(document.getElementById("expenseGroupChart"), {
                type: "doughnut",
                data: {
                    labels: Object.keys(groupTotals),
                    datasets: [{
                        label: "Expense",
                        data: Object.values(groupTotals)
                    }]
                }
            });

            // Receipts vs Expense
            const totalExp = exp.reduce((sum, r) => sum + toNumber(r.Amount), 0);
            const totalRec = rec.reduce((sum, r) => sum + toNumber(r.Amount), 0);

            if (receiptVsExpenseChart) receiptVsExpenseChart.destroy();
            receiptVsExpenseChart = new Chart(document.getElementById("receiptVsExpenseChart"), {
                type: "pie",
                data: {
                    labels: ["Expense", "Receipts"],
                    datasets: [{
                        data: [totalExp, totalRec]
                    }]
                }
            });
        }

        // ==========================
        // UPDATE DASHBOARD
        // ==========================
        function updateDashboard() {
            updateSummary();
            updateExpenseTable();
            updateReceiptTable();
            updateContraTable();

            // Delay charts for faster mobile experience
            setTimeout(() => {
                updateCharts();
            }, 400);
        }

        // ==========================
        // LOAD DATA
        // ==========================
        async function loadAllData() {
            document.getElementById("expenseTable").innerHTML = `<tr><td colspan="7" class="loading">Loading...</td></tr>`;
            document.getElementById("receiptTable").innerHTML = `<tr><td colspan="5" class="loading">Loading...</td></tr>`;
            document.getElementById("contraTable").innerHTML = `<tr><td colspan="5" class="loading">Loading...</td></tr>`;

            expenseData = removeEmptyRows(await parseCSV(expenseCSV));
            receiptData = removeEmptyRows(await parseCSV(receiptsCSV));
            contraData = removeEmptyRows(await parseCSV(contraCSV));

            fillMonthDropdown();
            updateDashboard();
        }

        // Search update
        document.getElementById("searchBox").addEventListener("input", () => {
            updateDashboard();
        });

        // Initial load
        loadAllData();
    </script>

</body>

</html>
